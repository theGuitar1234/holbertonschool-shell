#!/usr/bin/env bash
# This is a comment

awk '
{
  ip = $1
  if (ip !~ /^[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+$/) next

  # Extract status code from: "REQUEST" <code> ...
  if (match($0, /"[^"]*" [0-9][0-9][0-9] /)) {
    code = substr($0, RSTART + RLENGTH - 4, 3)
  } else if (match($0, /"[^"]*" [0-9][0-9][0-9]$/)) {
    code = substr($0, RSTART + RLENGTH - 3, 3)
  } else {
    next
  }

  print ip, code
}
' apache-access.log \
| sort \
| uniq -c \
| sort -nr \
| awk '{ printf "%7d %s %s\n", $1, $2, $3 }'
